<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image to Text (OCR)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tesseract.js -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Patrick+Hand&display=swap');
    </style>
</head>

<body class="bg-gray-50 h-screen overflow-hidden font-['Outfit']">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef } = React;

        // Simple inline SVG icons (no external dependency)
        const Icons = {
            image: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><circle cx="9" cy="9" r="2" /><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" /></svg>,
            upload: <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></svg>,
            imagePlus: <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7" /><line x1="16" x2="22" y1="5" y2="5" /><line x1="19" x2="19" y1="2" y2="8" /><circle cx="9" cy="9" r="2" /><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" /></svg>,
            zoomIn: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8" /><line x1="21" x2="16.65" y1="21" y2="16.65" /><line x1="11" x2="11" y1="8" y2="14" /><line x1="8" x2="14" y1="11" y2="11" /></svg>,
            zoomOut: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8" /><line x1="21" x2="16.65" y1="21" y2="16.65" /><line x1="8" x2="14" y1="11" y2="11" /></svg>,
            scanText: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2" /><path d="M17 3h2a2 2 0 0 1 2 2v2" /><path d="M21 17v2a2 2 0 0 1-2 2h-2" /><path d="M7 21H5a2 2 0 0 1-2-2v-2" /><path d="M7 8h8" /><path d="M7 12h10" /><path d="M7 16h6" /></svg>,
            fileText: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" x2="8" y1="13" y2="13" /><line x1="16" x2="8" y1="17" y2="17" /><line x1="10" x2="8" y1="9" y2="9" /></svg>,
            copy: <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></svg>,
            arrowLeft: <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" x2="5" y1="12" y2="12" /><polyline points="12 19 5 12 12 5" /></svg>,
        };

        // Post-processing function to clean up OCR text
        const cleanText = (rawText, lang) => {
            let cleaned = rawText;

            if (lang === 'chi_sim' || lang === 'jpn') {
                const cjk = "[\u4e00-\u9fff\u3000-\u303f\uff00-\uffef\u3040-\u30ff]";
                const regex = new RegExp(`(${cjk})\\s+(${cjk})`, 'g');

                let old = "";
                while (old !== cleaned) {
                    old = cleaned;
                    cleaned = cleaned.replace(regex, '$1$2');
                }
            }

            return cleaned.trim();
        };

        const App = () => {
            const [image, setImage] = useState(null);
            const [text, setText] = useState("");
            const [isProcessing, setIsProcessing] = useState(false);
            const [progress, setProgress] = useState(0);
            const [status, setStatus] = useState("Ready");
            const [language, setLanguage] = useState("eng");
            const [autoClean, setAutoClean] = useState(true);

            const [scale, setScale] = useState(1);
            const [pan, setPan] = useState({ x: 0, y: 0 });
            const [isDragging, setIsDragging] = useState(false);
            const [dragStart, setDragStart] = useState({ x: 0, y: 0 });

            const [ocrWords, setOcrWords] = useState([]);
            const [highlights, setHighlights] = useState([]);

            const fileInputRef = useRef(null);
            const imageRef = useRef(null);
            const containerRef = useRef(null);

            const handleFile = (file) => {
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setImage(e.target.result);
                        setScale(1);
                        setPan({ x: 0, y: 0 });
                    };
                    reader.readAsDataURL(file);
                    setText("");
                    setOcrWords([]);
                    setHighlights([]);
                    setProgress(0);
                    setStatus("Ready");
                }
            };

            const runOCR = async () => {
                if (!image) return;
                setIsProcessing(true);
                setText("");
                setHighlights([]);
                setProgress(10);
                setStatus("Step 1/4: Loading AI model...");

                const timeout = setTimeout(() => {
                    setIsProcessing(false);
                    setStatus("Error: Timeout - process took too long. Try a smaller image.");
                }, 120000);

                try {
                    const worker = await Tesseract.createWorker(language);

                    setProgress(40);
                    setStatus("Step 2/4: AI model loaded ✓");

                    await new Promise(r => setTimeout(r, 300));

                    setProgress(60);
                    setStatus("Step 3/4: Scanning image...");

                    const result = await worker.recognize(image);
                    const rawText = result.data.text;
                    const words = result.data.words;

                    setOcrWords(words);

                    setProgress(90);
                    setStatus("Step 4/4: Post-processing...");

                    await worker.terminate();

                    const finalText = autoClean ? cleanText(rawText, language) : rawText;

                    clearTimeout(timeout);
                    setText(finalText);
                    setProgress(100);
                    setStatus("✓ Completed");
                } catch (err) {
                    clearTimeout(timeout);
                    console.error(err);
                    setStatus("Error: " + (err.message || "Unknown error"));
                } finally {
                    setIsProcessing(false);
                }
            };

            const handleWheel = (e) => {
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    const delta = e.deltaY * -0.01;
                    const newScale = Math.min(Math.max(0.5, scale + delta), 5);
                    setScale(newScale);
                }
            };

            const startDrag = (e) => {
                if (e.target.tagName !== 'IMG' && !e.target.classList.contains('image-container')) return;
                setIsDragging(true);
                setDragStart({ x: e.clientX - pan.x, y: e.clientY - pan.y });
            };

            const doDrag = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                setPan({ x: e.clientX - dragStart.x, y: e.clientY - dragStart.y });
            };

            const endDrag = () => {
                setIsDragging(false);
            };

            const handleTextSelect = (e) => {
                const selection = window.getSelection().toString().trim();
                if (!selection || ocrWords.length === 0) {
                    setHighlights([]);
                    return;
                }

                const matchedRects = [];

                // For CJK: match individual characters
                const isCJK = language === 'chi_sim' || language === 'jpn';

                if (isCJK) {
                    // Split selection into individual characters
                    const selectedChars = selection.replace(/\s+/g, '').split('');

                    ocrWords.forEach(word => {
                        const wText = word.text.trim();
                        // Only match if word contains the selected characters
                        if (selectedChars.some(char => wText.includes(char))) {
                            matchedRects.push(word.bbox);
                        }
                    });
                } else {
                    // For alphabetic languages
                    const searchTerms = selection.toLowerCase().split(/\s+/).filter(s => s.length > 0);

                    ocrWords.forEach(word => {
                        const wText = word.text.trim().toLowerCase();
                        const cleanWord = wText.replace(/[^\w]/g, '');
                        if (searchTerms.some(term => {
                            const cleanTerm = term.replace(/[^\w]/g, '');
                            return cleanWord === cleanTerm;
                        })) {
                            matchedRects.push(word.bbox);
                        }
                    });
                }

                setHighlights(matchedRects);
            };

            const copyToClipboard = () => {
                navigator.clipboard.writeText(text);
                setStatus("✓ Copied to clipboard!");
                setTimeout(() => setStatus(text ? "✓ Completed" : "Ready"), 2000);
            };

            const clearAll = () => {
                setImage(null);
                setText("");
                setOcrWords([]);
                setHighlights([]);
                setProgress(0);
                setStatus("Ready");
                setScale(1);
                setPan({ x: 0, y: 0 });
            };

            const reCleanText = () => {
                if (text) {
                    setText(cleanText(text, language));
                    setStatus("✓ Text cleaned");
                }
            };

            return (
                <div className="flex h-screen w-full bg-[#f3f4f6]" onDragOver={(e) => e.preventDefault()} onDrop={(e) => { e.preventDefault(); handleFile(e.dataTransfer.files[0]) }}>

                    {/* Left Column: Image Area */}
                    <div className="w-1/2 flex flex-col border-r border-gray-200">
                        {/* Header */}
                        <div className="p-4 bg-white border-b flex justify-between items-center z-20 shadow-sm">
                            <h1 className="text-xl font-bold flex items-center gap-2">{Icons.image} Input Image</h1>
                            <div className="flex gap-2">
                                <select
                                    className="bg-gray-50 border rounded px-3 py-1.5 text-sm font-semibold"
                                    value={language}
                                    onChange={(e) => setLanguage(e.target.value)}
                                    disabled={isProcessing}
                                >
                                    <option value="eng">English</option>
                                    <option value="chi_sim">Chinese (Simplified)</option>
                                    <option value="jpn">Japanese</option>
                                </select>
                                <button
                                    onClick={() => fileInputRef.current.click()}
                                    className="px-4 py-1.5 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded shadow-sm text-sm font-bold flex items-center gap-2"
                                    disabled={isProcessing}
                                >
                                    {Icons.upload} Upload
                                </button>
                                <input type="file" hidden ref={fileInputRef} onChange={(e) => handleFile(e.target.files[0])} accept="image/*" />
                            </div>
                        </div>

                        {/* Image Viewer */}
                        <div
                            className="flex-1 bg-gray-100 overflow-hidden relative cursor-grab active:cursor-grabbing image-container"
                            ref={containerRef}
                            onMouseDown={startDrag}
                            onMouseMove={doDrag}
                            onMouseUp={endDrag}
                            onMouseLeave={endDrag}
                            onWheel={handleWheel}
                        >
                            {image ? (
                                <div
                                    className="origin-top-left transition-transform duration-75 relative inline-block"
                                    style={{ transform: `translate(${pan.x}px, ${pan.y}px) scale(${scale})` }}
                                >
                                    <img
                                        ref={imageRef}
                                        src={image}
                                        className="max-w-none pointer-events-none select-none shadow-xl"
                                        alt="Preview"
                                        draggable="false"
                                    />

                                    {/* Highlights Overlay */}
                                    {highlights.map((rect, i) => (
                                        <div
                                            key={i}
                                            className="absolute border-2 border-yellow-400 bg-yellow-400/30 pointer-events-none"
                                            style={{
                                                left: rect.x0,
                                                top: rect.y0,
                                                width: rect.x1 - rect.x0,
                                                height: rect.y1 - rect.y0
                                            }}
                                        />
                                    ))}
                                </div>
                            ) : (
                                <div className="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                                    <div className="mb-4 opacity-50">{Icons.imagePlus}</div>
                                    <p className="font-bold">Drag & Drop Image Here</p>
                                </div>
                            )}

                            {/* Zoom Controls */}
                            {image && (
                                <div className="absolute bottom-6 right-6 flex flex-col gap-2 bg-white/90 p-2 rounded-lg shadow-lg backdrop-blur border border-gray-200 z-10">
                                    <button onClick={() => setScale(s => Math.min(s + 0.25, 5))} className="p-2 hover:bg-gray-100 rounded" title="Zoom In">{Icons.zoomIn}</button>
                                    <button onClick={() => setScale(1)} className="p-2 hover:bg-gray-100 rounded text-xs font-bold font-mono" title="Reset">100%</button>
                                    <button onClick={() => setScale(s => Math.max(s - 0.25, 0.5))} className="p-2 hover:bg-gray-100 rounded" title="Zoom Out">{Icons.zoomOut}</button>
                                </div>
                            )}

                            {/* Scanner Overlay */}
                            {image && !isProcessing && !text && (
                                <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <button
                                        onClick={runOCR}
                                        className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-full font-bold shadow-2xl transform hover:scale-105 transition-all flex items-center gap-3 pointer-events-auto text-lg"
                                    >
                                        {Icons.scanText} Start Extraction
                                    </button>
                                </div>
                            )}

                            {isProcessing && (
                                <div className="absolute inset-0 bg-white/80 backdrop-blur-md flex flex-col items-center justify-center gap-4 z-50">
                                    <div className="w-64 bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner">
                                        <div className="bg-blue-600 h-full rounded-full transition-all duration-500 ease-out" style={{ width: `${progress}%` }}></div>
                                    </div>
                                    <div className="font-bold text-gray-800 text-lg animate-pulse">{status}</div>
                                </div>
                            )}
                        </div>

                        {/* Image Footer options */}
                        <div className="bg-white p-2 border-t text-xs flex justify-between items-center text-gray-500 px-4">
                            <span>Scroll to Zoom • Drag to Pan</span>
                            <label className="flex items-center gap-2 cursor-pointer font-semibold text-gray-700 hover:text-blue-600">
                                <input type="checkbox" checked={autoClean} onChange={(e) => setAutoClean(e.target.checked)} className="rounded accent-blue-600" />
                                <span>Auto-Clean Text</span>
                            </label>
                        </div>
                    </div>

                    {/* Right Column: Text Area */}
                    <div className="w-1/2 flex flex-col bg-white shadow-xl z-20">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                            <h1 className="text-xl font-bold flex items-center gap-2">{Icons.fileText} Extracted Text</h1>
                            <div className="flex gap-2">
                                <button onClick={reCleanText} className="px-3 py-1.5 hover:bg-blue-100 text-blue-600 rounded text-sm font-bold border border-transparent hover:border-blue-200 transition-colors" disabled={!text}>Clean Spaces</button>
                                <button onClick={clearAll} className="px-3 py-1.5 hover:bg-red-100 text-red-600 rounded text-sm font-bold border border-transparent hover:border-red-200 transition-colors" disabled={isProcessing}>Clear</button>
                                <button onClick={copyToClipboard} className="px-4 py-1.5 bg-gray-900 text-white hover:bg-gray-800 rounded shadow-md hover:shadow-lg text-sm font-bold flex items-center gap-2 transform active:scale-95 transition-all" disabled={!text}>
                                    {Icons.copy} Copy
                                </button>
                            </div>
                        </div>

                        <div className="flex-1 relative">
                            <textarea
                                className="w-full h-full bg-white p-8 outline-none resize-none font-mono text-base leading-loose text-gray-800 selection:bg-yellow-200 selection:text-black"
                                placeholder="Select text here to see it highlighted on the left..."
                                value={text}
                                onChange={(e) => setText(e.target.value)}
                                onSelect={handleTextSelect}
                            ></textarea>

                            {!text && !isProcessing && (
                                <div className="absolute inset-0 flex items-center justify-center pointer-events-none opacity-30 select-none">
                                    <div className="text-center">
                                        <div className="mx-auto mb-2 opacity-50">{Icons.arrowLeft}</div>
                                        <p className="text-lg">Scan an image to start</p>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Status Bar */}
                        <div className="h-8 bg-gray-100 border-t flex items-center justify-between px-4 text-xs text-gray-500 font-mono">
                            <span>{status}</span>
                            <span>Powered by Tesseract.js v5</span>
                        </div>
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>